<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Login</title>
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<style>
    * {
        box-sizing: border-box;
    }

    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    #app {
        margin: 0 auto;
        width: 450px;
    }

    #id_button {
        margin: 0 auto;
        width: 450px;
    }
</style>
<body>
<div id="app">
    <el-input v-model="username_input" placeholder="请输入用户名" @blur="QueryUsername"></el-input>
    <p id="user-name-error"></p>
    <el-input placeholder="请输入密码" v-model="password_input" show-password></el-input>
    <el-button id="id_button" type="primary" id="user-login-button" :disabled="buttonDisabled" @click="UserLogin">登录
    </el-button>
</div>
<script>
    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    let app = new Vue({
        el: '#app',
        data: {
            username_input: '',
            password_input: '',
            buttonDisabled: true,
        },
        mounted: function () {
            //this.()
        },
        methods: {
            QueryUsername: function () {
                let Username = this.username_input
                $.ajax({
                    type: 'POST',
                    url: '/login/verification_username',
                    data: {
                        username: Username
                    },
                    success: (res) => {
                        //console.log(res)
                        //console.log(res.data.status.toString())
                        let UsernameError = document.getElementById("user-name-error")
                        if (res.data.status === "已存在") {
                            this.buttonDisabled = false;
                            UsernameError.innerText = ""
                        }
                        else {
                            this.buttonDisabled = true
                            UsernameError.innerText = "该用户名不存在"
                        }
                    },
                    fail: (res) => {
                        console.log(res)
                        console.log("Login fail")
                        this.buttonDisabled = true;
                    }
                })
            },
            UserLogin: function () {
                let Username = this.username_input
                let Password = this.password_input
                $.ajax({
                    type: 'POST',
                    url: '/login/login',
                    data: {
                        username: Username,
                        password: Password
                    },
                    success: (res) => {
                        console.log(res)
                        if (res.data.result === '登录成功') {

                            setCookie('username', Username, 3600 * 24)
                            setCookie('user_id', res.data.user_id, 3600 * 24)
                            setCookie('token', res.data.token, 3600 * 24)
                            console.log("username : " + getCookie("username"))
                            console.log("user_id : " + getCookie("user_id"))
                            console.log("token : " + getCookie("token"))

                            let url = 'http://localhost:8444/index.html'
                            window.open(url)
                        }
                        else {
                            alert("抱歉，" + res.data.result)
                        }

                    },
                    fail: (res) => {
                        console.log(res)
                    }
                })
            }
        }
    })
</script>
</body>
</html>