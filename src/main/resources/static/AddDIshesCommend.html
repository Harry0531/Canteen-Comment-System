<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>添加评论</title>
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>
<div id="app">
    <!--菜品评分-->
    <el-rate v-model="dish_value" show-text></el-rate>

    <!--菜品评价-->
    <el-input
            type="textarea"
            placeholder="请输入内容"
            v-model="dish_content"
            maxlength="30"
            show-word-limit
    >
    </el-input>

    <!--评价图片-->
    <el-upload
            class="upload-demo"
            drag
            action="http://120.79.204.39:8444/upload/comment"
            multiple
            :on-success="AddPhotoSuccess">
        <i class="el-icon-upload"></i>
        <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
        <div class="el-upload__tip" slot="tip">只能上传jpg/png文件，且不超过500kb</div>
    </el-upload>

    <el-button type="success" plain @click="AddDishCommend">提交评论</el-button>

</div>
</body>
<script>
    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    function GetRequest() {
        var url = location.search; //获取url中"?"符后的字串
        if (url.indexOf("?") != -1) {  //判断是否有参数
            var str = url.substr(1); //从第一个字符开始 因为第0个是?号 获取所有除问号的所有符串
            strs = str.split("=");  //用等号进行分隔 （因为知道只有一个参数 所以直接用等号进分隔 如果有多个参数 要用&号分隔 再用等号进行分隔）
            //alert(strs[1]);     //直接弹出第一个参数 （如果有多个参数 还要进行循环的）
            return strs[1];
        }
    }

    let app=new Vue({
        el:'#app',
        data:{
            dish_value:0,
            dish_content:'',
            dish_photo_name:'',
        },
        mounted:function () {

        },
        methods:{
            AddDishCommend:function () {
                let token_in_Cookie = getCookie("token")
                console.log("getCookie : " + getCookie("token"))
                let dish_id = GetRequest();
                let user_id= getCookie("iser_id")
                let DishValue=app.dish_value
                let DishContent=app.dish_content
                let PhotoName=app.dish_photo_name
                $.ajax({
                    type: 'POST',
                    url: '/comment/add',
                    headers: {
                        token: token_in_Cookie
                    },
                    data: {
                        dishId:dish_id,
                        userId:user_id,
                        level: DishValue,
                        content:DishContent,
                        photo:PhotoName,
                    },
                    success: function (res) {
                        console.log(res)
                        let url='http://localhost:8444/DishesCommend.html' + '?id='+GetRequest()
                        window.open(url)
                    },
                    fail: function (res) {
                        console.log(res)
                    }
                })
            },
            AddPhotoSuccess: function (response) {
                //function(response, file, fileList)
                console.log(response);
                this.dish_photo_name = response.data.filename
            },
        }
    })
</script>
</html>