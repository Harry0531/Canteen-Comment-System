<!DOCTYPE html>
<html xmlns:url="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <title>DishesCommand</title>
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<style>
    * {
        box-sizing: border-box;
    }

    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
    }
</style>
<body>
<div id="app">
    <div id="dish">
        <p id="dish_name">菜品名称</p>

        <el-rate
                v-model="value"
                disabled
                show-score
                text-color="#ff9900"
                score-template="{value}">
        </el-rate>

        <p id="dish_price">菜品价格</p>

        <p id="dish_canteen">食堂地点</p>

        <p id="dish_floor">楼层</p>

        <p id="dish_window">窗口</p>

        <p id="dish_discription">详细描述</p>

        <i :class="star_type" @click="DishChangeLike"></i>
        <p id="dish_likes">点赞数量</p>

        <el-button type="primary" icon="el-icon-edit" circle @click="AddDishCommend"></el-button>


        <template>
            <el-table
                    :data="dish_comment_list"
                    border
                    style="width: 100%">
                <el-table-column
                        prop="commentId"
                        label="评论id"
                        width="180">
                </el-table-column>
                <el-table-column
                        prop="userId"
                        label="用户id"
                        width="180">
                </el-table-column>
                <el-table-column
                        prop="time"
                        label="日期"
                        width="180">
                </el-table-column>
                <el-table-column
                        prop="content"
                        label="评论内容">
                </el-table-column>
                <el-table-column
                        prop="level"
                        label="星级评价"
                        @cell-click="CommendisLike"
                        width="180">
                </el-table-column>
                <el-table-column
                        prop="photo"
                        label="评论图片">
                </el-table-column>
                <!--<el-table-column-->
                        <!--label="点赞该评论"-->
                        <!--@cell-click="CommendisLike"-->
                        <!--width="180">-->
                <!--</el-table-column>-->
            </el-table>
        </template>

    </div>
</div>
</body>
<script>
    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    function GetRequest() {
        var url = location.search; //获取url中"?"符后的字串
        if (url.indexOf("?") != -1) {  //判断是否有参数
            var str = url.substr(1); //从第一个字符开始 因为第0个是?号 获取所有除问号的所有符串
            strs = str.split("=");  //用等号进行分隔 （因为知道只有一个参数 所以直接用等号进分隔 如果有多个参数 要用&号分隔 再用等号进行分隔）
            //alert(strs[1]);     //直接弹出第一个参数 （如果有多个参数 还要进行循环的）
            return strs[1];
        }
    }

    let app = new Vue({
        el: '#app',
        data: {
            value: 3.7,
            star_type: "el-icon-star-off",
            dish_comment_list: [],
        },
        mounted: function () {
            this.getDishData()
            this.getDishComment()
        },
        methods: {
            getDishData: function () {
                //console.log("??")
                let token_in_Cookie = getCookie("token")
                console.log("getCookie : " + getCookie("token"))
                let dish_id = GetRequest();
                $.ajax({
                    type: 'GET',
                    url: '/menu/info',
                    headers: {
                        token: token_in_Cookie
                    },
                    data: {
                        dishId: dish_id
                    },
                    success: function (res) {
                        DishName = document.getElementById("dish_name")
                        DishName.innerText = res.data.name

                        console.log(app.value)
                        app.value = res.data.level
                        console.log(app.value)

                        DishPrice = document.getElementById("dish_price")
                        DishPrice.innerText = res.data.price

                        DishCanteen = document.getElementById("dish_canteen")
                        DishCanteen.innerText = res.data.loc_Canteen

                        DishFloor = document.getElementById("dish_floor")
                        DishFloor.innerText = res.data.loc_Floor

                        DishWindow = document.getElementById("dish_window")
                        DishWindow.innerText = res.data.loc_Window

                        DishDiscription = document.getElementById("dish_discription")
                        DishDiscription.innerText = res.data.discription

                        DishLikes = document.getElementById("dish_likes")
                        DishLikes.innerText = res.data.likes

                    },
                    fail: function (res) {
                        console.log(res);
                    }
                })

            },
            getDishComment: function () {
                //console.log("??")
                let token_in_Cookie = getCookie("token")
                console.log("getCookie : " + getCookie("token"))
                let dish_id = GetRequest();
                $.ajax({
                    type: 'POST',
                    url: '/comment/query',
                    headers: {
                        token: token_in_Cookie
                    },
                    data: {
                        status: 2,//根据dishId查找评论
                        statusId: dish_id
                    },
                    success: function (res) {
                        console.log(res.data)
                        app.dish_comment_list = res.data
                    },
                    fail: function (res) {
                        console.log(res);
                    }
                })
            },
            DishChangeLike: function () {
                if (app.star_type === "el-icon-star-on") {
                    app.star_type = "el-icon-star-off"
                    app.DishNotLike()
                    DishLikes = document.getElementById("dish_likes")
                    DishLikes.innerText = parseInt(DishLikes.innerText) - 1
                }
                else {
                    app.star_type = "el-icon-star-on"
                    app.DishisLike()
                    DishLikes = document.getElementById("dish_likes")
                    DishLikes.innerText = parseInt(DishLikes.innerText) + 1
                }
            },
            DishisLike: function () {
                let token_in_Cookie = getCookie("token")
                //console.log("token : " + token_in_Cookie)
                let userid_in_Cookie = getCookie("user_id")
                //console.log("user_id : " + userid_in_Cookie)
                let dish_id = GetRequest();
                $.ajax({
                    type: 'POST',
                    url: '/like/add',
                    headers: {
                        token: token_in_Cookie
                    },
                    data: {
                        userId: userid_in_Cookie,
                        type: 1,
                        like_id: dish_id,
                    },
                    success: function (res) {
                        console.log(res)
                    },
                    fail: function (res) {
                        console.log(res);
                    }
                })
            },
            DishNotLike: function () {
                let token_in_Cookie = getCookie("token")
                //console.log("token : " + token_in_Cookie)
                let userid_in_Cookie = getCookie("user_id")
                //console.log("user_id : " + userid_in_Cookie)
                let dish_id = GetRequest();
                $.ajax({
                    type: 'POST',
                    url: '/like/cancel',
                    headers: {
                        token: token_in_Cookie
                    },
                    data: {
                        userId: userid_in_Cookie,
                        type: 1,
                        like_id: dish_id,
                    },
                    success: function (res) {
                        console.log(res)
                    },
                    fail: function (res) {
                        console.log(res);
                    }
                })
            },
            AddDishCommend:function () {
                let url='http://localhost:8444/AddDishesCommend.html' + '?id='+GetRequest()
                window.open(url)
            },
            CommendisLike:function () {
                alert("666")
            }
        }
    })
</script>
</html>